(function(){var e,t,r,n,o,i,a,s,l,u,c,p,h,f,d,g,m,v,k,y,b,q,w,x,C,A,O=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};c="AIzaSyCOHL5Z1IEHvbbt71ASsVbMWwZnP9JUOjg",f=require("http"),y=require("request"),a=require("cheerio"),l=require("fs"),e=require("cron").CronJob,r=require("youtube-node"),v=require("moment"),n=require("async"),A=new r,q=[],k="../songs.json",g="http://mwave.interest.me/kpop/chart.m",d="http://www.mnet.com/chart/TOP100/20150328",u="http://gaonchart.co.kr/main/section/chart/online.gaon?serviceGbn=S1040&termGbn=week&hitYear=2015&targetTime=13&nationGbn=K",m="http://mwave.interest.me/mcountdown/voteState.m",x=[g,m,u],s=v().subtract(3,"months").format("YYYY-MM-DDTHH:mm:ssZ"),o=["simply k-pop","tease","teaser","phone","iPhone","iPad","Gameplay","cover","acoustic","instrumental","remix","mix","re mix","re-mix","version","ver.","live","live cover","accapella","cvr"],C=["mnet","full audio","kpop","k pop","k-pop","korean","korea","kor","kor pop","korean pop","korean-pop","kor-pop","korean version","kr","kr ver","official","mv","m/v","music video"],h=/[\u1100-\u11FF\u3130-\u318F\uA960-\uA97F\uAC00-\uD7AF\uD7B0-\uD7FF]/g,A.setKey(c),A.addParam("type","video"),A.addParam("part","id"),A.addParam("order","relevance"),A.addParam("publishedAfter",s),A.addParam("videoDefinition","high"),A.addParam("videoEmbeddable","true"),t=function(e,t){var r,n,o,i,a,s,l,u,c,p,h,f,d,g,m;if(u=e.length,l=t.length,0===u)return l;if(0===l)return u;for(i=[],a=c=0;u>=0?u>=c:c>=u;a=u>=0?++c:--c)i[a]=[];for(a=p=0;u>=0?u>=p:p>=u;a=u>=0?++p:--p)i[a][0]=a;for(s=h=0;l>=0?l>=h:h>=l;s=l>=0?++h:--h)i[0][s]=s;for(a=f=0,d=e.length;d>f;a=++f)for(r=e[a],s=m=0,g=t.length;g>m;s=++m)n=t[s],o=r===n?0:1,i[a+1][s+1]=Math.min(i[a][s+1]+1,i[a+1][s]+1,i[a][s]+o);return i[u][l]},i=function(e,t){var r,n,o,i,a,s,l,u,c,p,f,d,g,m,v,k,y,b,q,w;for(g=e.snippet.title,i=e.snippet.description,f=0,p=0,o=g.replace(/[^A-Za-z0-9\s]+/g,"").replace(/\s+/g," ").toLowerCase().trim(),r=i.replace(/[^A-Za-z0-9\s]+/g,"").replace(/\s+/g," ").toLowerCase().trim(),n=t.replace(/[^A-Za-z0-9\s]+/g,"").replace(/\s+/g," ").toLowerCase().trim(),h.test(g)===!0&&f++,h.test(i)===!0&&f++,u=0,l=0,y=0,q=C.length;q>y;y++)d=C[y],-1!==g.indexOf(d)&&u++,-1!==i.indexOf(d)&&l++;for(u>0&&f++,l>0&&f++,v=o.split(" "),s=r.split(" "),c=n.split(" "),m=0,a=0,b=0,w=c.length;w>b;b++)k=c[b],O.call(v,k)>=0&&m++,O.call(s,k)>=0&&a++;return(m=c.length||(a=c.length))&&(f+=3),f},p=function(e,t){return y(e,function(r,n,o){var $;return r&&console.log(r),r||200!==n.statusCode?void 0:($=a.load(o),e===g&&$("div.list_song tr").each(function(e,t){var r,n,o,i,a;return r=$(this).find(".tit_artist a:first-child").text().replace("(","").replace(")","").replace("'",""),a=$(this).find(".tit_song a").text().replace("(","").replace(")","").replace("'",""),i=$(this).find(".nb em").text(),o=""+r+" "+a,null!=r&&""!==r?(n={artist:r,title:a,query:o.toLowerCase(),rank:i},q.push(n)):void 0}),e===m&&$(".vote_state_list tr").each(function(e,t){var r,n,o,i,a;return r=$(this).find(".artist a").text().replace("(","").replace(")","").replace("'",""),a=$(this).find(".music_icon a:nth-child(2)").text().replace("(","").replace(")","").replace("'",""),i=$(this).find(".rank img").attr("alt"),o=""+r+" "+a,null!=r&&""!==r?(n={artist:r,title:a,query:o.toLowerCase(),rank:i},q.push(n)):void 0}),e===u&&$(".chart tr").each(function(e,t){var r,n,o,i,a;return r=$(this).find(".subject p:nth-child(2)").text().split("|")[0].replace("(","").replace(")","").replace("'",""),a=$(this).find(".subject p:first-child").text().replace("(","").replace(")","").replace("'",""),i=$(this).find(".ranking span").text(),""===i&&(i=$(this).find(".ranking").text()),o=""+r+" "+a,null!=r&&""!==r?(n={artist:r,title:a,query:o.toLowerCase(),rank:i},q.push(n)):void 0}),t())})},w=function(){return n.each(x,function(e,t){p(e,function(){return console.log("in get data "+e),t()})},function(e){var r,a,s,l,u,c,p,h,f,d,g,m,v,k;if(e)console.log(e);else{for(console.log("in return"),c=[],g=0,v=q.length;v>g;g++)f=q[g],p=function(){var e,t,r;for(r=[],e=0,t=c.length;t>e;e++)l=c[e],r.push(l.query);return r}(),h=function(){var e,t,r;for(r=[],e=0,t=c.length;t>e;e++)u=c[e],r.push(u.title);return r}(),a=function(){var e,r,n;for(n=[],e=0,r=p.length;r>e;e++)l=p[e],t(f.query,l)<3&&n.push(l);return n}(),s=function(){var e,r,n;for(n=[],e=0,r=h.length;r>e;e++)u=h[e],t(f.title,u)<3&&n.push(u);return n}(),0===a.length&&0===s.length&&c.push(f);for(c.sort(function(e,t){return e.rank-t.rank}),r=m=0,k=c.length;k>m;r=++m)d=c[r],d.rank=r+1;q=c,n.each(q,function(e,t){return A.search(e.query,50,function(r,n){var a;return r?(console.log(r),t()):n.pageInfo.totalResults<10?(console.log("not enough songs for "+e.query),t()):n.items[0]?null==n.items[0].id?(console.log("no id for "+e.query),t()):(a=n.items[0].id.videoId,A.getById(a,function(r,n){var s,l,u,c,p,h,f,d,g;if(r)return console.log(r),t();for(u=n.items[0],h=u.snippet.title,l=u.snippet.description,f=u.statistics.viewCount,s=0,d=0,g=o.length;g>d;d++)p=o[d],-1!==h.indexOf(p)&&s++,-1!==l.indexOf(p)&&s++;return c=i(u,e.query),s>0||3>c||5e3>f?(console.log(""+e.query+" doesn't pass checks: score: "+c+", bad: "+s),t()):(e.youtubeId=a,e.statistics=u.statistics,t())})):(console.log("no matches for "+e.query),t())})},function(e){return e?console.log(e):(console.log("All songs have been processed successfully"),b())})}})},b=function(){var e;return q=function(){var t,r,n;for(n=[],t=0,r=q.length;r>t;t++)e=q[t],null!=e.youtubeId&&n.push(e);return n}(),l.writeFile(k,JSON.stringify(q),function(e){if(e)throw e;console.log("JSON saved to "+k)}),y.post({url:"http://jombly.com:3000/update",body:JSON.stringify(q),headers:{"Content-Type":"application/json;charset=UTF-8"}},function(e,t,r){console.log("error code: "+e),console.log("status code: "+t.statusCode)})},w()}).call(this);