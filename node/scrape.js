(function(){var e,t,r,i,n,o,a,s,l,u,c,p,d,f,h,m,v,g,k,b,w,x,y,q=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1};c=require("http"),v=require("request"),o=require("cheerio"),s=require("fs"),e=require("cron").CronJob,t=require("youtube-node"),h=require("moment"),r=require("async"),y=new t,k=[],m="../songs.json",d="http://mwave.interest.me/kpop/chart.m",p="",f="http://mwave.interest.me/mcountdown/voteState.m",w=[d,f,p],a=h().subtract(3,"months").format("YYYY-MM-DDTHH:mm:ssZ"),i=["simply k-pop","tease","teaser","phone","iPhone","iPad","Gameplay","cover","acoustic","instrumental","remix","mix","re mix","re-mix","version","ver.","live","live cover","accapella","cvr"],x=["mnet","full audio","kpop","k pop","k-pop","korean","korea","kor","kor pop","korean pop","korean-pop","kor-pop","korean version","kr","kr ver","official","mv","m/v","music video"],u=/[\u1100-\u11FF\u3130-\u318F\uA960-\uA97F\uAC00-\uD7AF\uD7B0-\uD7FF]/g,y.setKey("AIzaSyCOHL5Z1IEHvbbt71ASsVbMWwZnP9JUOjg"),y.addParam("type","video"),y.addParam("part","id"),y.addParam("order","relevance"),y.addParam("publishedAfter",a),y.addParam("videoDefinition","high"),y.addParam("videoEmbeddable","true"),n=function(e,t){var r,i,n,o,a,s,l,c,p,d,f,h,m,v,g,k,b,w,y,A;for(m=e.snippet.title,o=e.snippet.description,f=0,d=0,n=m.replace(/[^A-Za-z0-9\s]+/g,"").replace(/\s+/g," ").toLowerCase().trim(),r=o.replace(/[^A-Za-z0-9\s]+/g,"").replace(/\s+/g," ").toLowerCase().trim(),i=t.replace(/[^A-Za-z0-9\s]+/g,"").replace(/\s+/g," ").toLowerCase().trim(),u.test(m)===!0&&f++,u.test(o)===!0&&f++,c=0,l=0,b=0,y=x.length;y>b;b++)h=x[b],-1!==m.indexOf(h)&&c++,-1!==o.indexOf(h)&&l++;for(c>0&&f++,l>0&&f++,g=n.split(" "),s=r.split(" "),p=i.split(" "),v=0,a=0,w=0,A=p.length;A>w;w++)k=p[w],q.call(g,k)>=0&&v++,q.call(s,k)>=0&&a++;return(v=p.length||(a=p.length))&&(f+=3),f},l=function(e,t){return v(e,function(r,i,n){var $;return!r&&200===i.statusCode&&($=o.load(n),(e=d)&&($("div.list_song tr").each(function(e,t){var r,i,n,o,a;return r=$(this).find(".tit_artist a:first-child").text().replace("(","").replace(")","").replace("'",""),a=$(this).find(".tit_song a").text().replace("(","").replace(")","").replace("'",""),o=$(this).find(".nb em").text(),n=""+r+" "+a,null!=r&&""!==r?(i={artist:r,title:a,query:n.toLowerCase(),rank:o},k.push(i)):void 0}),t()),e=f)?($(".vote_state_list tr").each(function(e,t){var r,i,n,o,a;return r=$(this).find(".artist a").text(),a=$(this).find(".music_icon a:nth-child(2)").text(),o=$(this).find(".rank img").attr("alt"),n=""+r+" "+a,null!=r&&""!==r?(i={artist:r,title:a,query:n.toLowerCase(),rank:o},k.push(i)):void 0}),t()):void 0})},b=function(){return r.eachSeries(w,function(e,t){l(e,function(){return t()})},function(e){e?console.log(e):(console.log("All files have been processed successfully"),console.log(k))})},g=function(){var e;return k=function(){var t,r,i;for(i=[],t=0,r=k.length;r>t;t++)e=k[t],null!=e.youtubeId&&i.push(e);return i}(),s.writeFile(m,JSON.stringify(k),function(e){if(e)throw e;console.log("JSON saved to "+m)})},b()}).call(this);